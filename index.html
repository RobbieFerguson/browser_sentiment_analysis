<!doctype html>
<html>
  <head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
	<style>
	body {
	  font-family: "Helvetica Neue", helvetica, arial;
	  padding: 15px;
	  background-color: orange;
	}
	ul {
	  list-style: none;
	  margin: 0;
	  padding: 0;
	}
	ul li {
	  line-height: 1.4;
	}
	</style>
  </head>
  <body>
   <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
		var socket = io();
      var navigator = window.navigator;
      navigator.getUserMedia = (
        navigator.getUserMedia ||
          navigator.webkitGetUserMedia ||
          navigator.mozGetUserMedia ||
          navigator.msGetUserMedia
      );

      var Context = window.AudioContext || window.webkitAudioContext;
      var context = new Context();

      var mediaStream;
      var rec;

	    $( document ).ready(function() {
			$('#talk').click(function(){
            //
            $("#talk").prop("disabled", true); //disable button for speaking
            $("#stop").prop("disabled", false); //enable button for stop speaking
   			console.log("record and break up into sections");
            // ask for permission and start recording
           navigator.getUserMedia({audio: true}, function(localMediaStream){
             mediaStream = localMediaStream;

             // create a stream source to pass to Recorder.js
             var mediaStreamSource = context.createMediaStreamSource(localMediaStream);

             // create new instance of Recorder.js using the mediaStreamSource
             rec = new Recorder(mediaStreamSource, {
               // pass the path to recorderWorker.js file here
               workerPath: '/bower_components/Recorderjs/recorderWorker.js'
             });

             // start recording
             rec.record();
           }, function(err){
             console.log('Browser not supported');
           });

           //send in 5 second intervals
           id = setInterval(function() {
             rec.exportWAV(function(e){
                rec.stop();
                rec.clear();
                socket.emit('talk', e);});
           }, 5000)
            //
            console.log("send audiofile");
            socket.emit('talk', (new Date));
				return false;
			});

         $('#stop').click(function(){
            //
            $("#talk").prop("disabled", false); //enable button for speaking
            $("#stop").prop("disabled", true); //disable button for stop speaking

         });

			socket.on('message', function(msg){
            console.log(msg);
			});
		});
    </script>
    <script src="bower_components/Recorderjs/recorder.js"></script>
    <script src="bower_components/Recorderjs/recorderWorker.js"></script>
    <!--  -->
   <button id="talk">Talk</button>
   <button id="stop" disabled>Stop</button>
   <!--  -->
  </body>
</html>
